@using InventoryLibrary.Data
@using InventoryLibrary.Services.Interfaces
@using InventoryLibrary.Model.Location
@using InventoryWeb.Models
@using Microsoft.EntityFrameworkCore
@rendermode InteractiveServer
@inject ITypeService typeService;
@inject IConditionService conditionService;
@inject ILocationService locationService;
@inject NavigationManager navigation;


<div class="card" style="width: 18rem;">
  <div class="card-body">
    <h5 class="card-title">
        <Icon Name="icon" Color="color" Size="IconSize.x4"/>
        <b>@Title</b>
    </h5>
    <p class="card-text">
        @if (Type == CategoryFormMode.Rooms)
        {
            if (roomsList == null || roomsList.Count == 0)
            {
                <i>No rooms added yet.</i>
            }
            else
            {
                @foreach (var r in roomsList)
                {
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>@r.RoomName (@(r.Department?.DepartmentName ?? "Unassigned"))</span>
                        <div>
                            <a class="text-decoration-none me-2" style="cursor: pointer;" @onclick="() => EditRoom(r.Id)">
                                <Icon Name="IconName.PencilFill" Color="color"/>
                            </a>
                            <a class="text-decoration-none me-2" style="cursor: pointer;" @onclick="() => DeleteRoom(r.Id)">
                                <Icon Name="IconName.TrashFill" Color="IconColor.Danger"/>
                            </a>
                        </div>
                    </div>
                }
            }
        }
        else
        {
            @if(Items == null || Items.Count == 0){
                <i>No @Title.ToLower() added yet.</i>
            }else{
                @foreach (var item in Items){
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>@item.Value</span>
                        <div>
                            @* Change Name *@
                            <a class="text-decoration-none me-2" style="cursor: pointer;" @onclick="@( e => showEditFormDialog(item.Key))" >
                                <Icon Name="IconName.PencilFill" Color="color"/>
                            </a>

                            @* Delete                                                                       add here deleting*@
                            <a class="text-decoration-none me-2" style="cursor: pointer;" @onclick="@( () => {})" >
                                <Icon Name="IconName.TrashFill" Color="IconColor.Danger"/>
                            </a>
                            <br/>
                        </div>
                    </div>
                }
            }
        }
    </p>
    
    @if(ShowAddButton){
    if (Type == CategoryFormMode.Rooms)
    {
        <hr />
        <button type="button" class="btn btn-primary btn-sm" @onclick="() => showRoomForm = !showRoomForm">+ Add New Room</button>
    }
    else
    {
        <hr />
        if (Type == CategoryFormMode.Departments)
        {
            <button type="button" class="btn btn-primary btn-sm" @onclick="NavigateToNewDepartment">+ Add New @buttonText</button>
        }
        else
        {
            <button type="button" class="btn btn-primary btn-sm">+ Add New @buttonText</button>
        }
    }
    }
  </div>
</div>



@if(showEditForm){
    @switch (Type)
    {
        case CategoryFormMode.Types:
            <TypeEditForm OnClose="@hideEditFormDialog" OnSubmit="@ChangeTitle" Name="@(Items[Id])"/>
            break;
         @* case CategoryFormMode.Conditions:
            <ConditionEditForm></ConditionEditForm>
            break; *@
        case CategoryFormMode.Departments:
            navigation.NavigateTo($"/categories/Edit-Department/{Id}");
            break;
    }
}

@if (showRoomForm && Type == CategoryFormMode.Rooms)
{
    <div class="mt-3">
        <input class="form-control d-inline-block w-50 me-2" placeholder="Room name" @bind="newRoomName" />
        <button class="btn btn-success btn-sm" @onclick="CreateRoom">Create</button>
        <button class="btn btn-secondary btn-sm ms-2" @onclick="() => showRoomForm = false">Cancel</button>
    </div>
}

@code {


[Parameter]
public CategoryFormMode Type {get;set;} = CategoryFormMode.Types;
[Parameter]
public Dictionary<int, string> Items {get;set;} = new Dictionary<int, string>();
[Parameter]
public bool ShowAddButton {get;set;} = false;
private int Id;
private string Title = "";
private IconName icon;
bool showEditForm = false;

private IconColor color = IconColor.None;




private string buttonText = "";
private List<Room> roomsList = new();
private bool showRoomForm = false;
private string newRoomName = string.Empty;

override protected async Task OnInitializedAsync()
{   
    switch (Type)
    {
        case CategoryFormMode.Types:
            Title = "Types";
            icon = IconName.TagFill;
            buttonText = "Type";
            color = IconColor.Primary;
            break;
        case CategoryFormMode.Conditions:
            Title = "Conditions";
            icon = IconName.ClipboardCheckFill;
            buttonText = "Condition";
            color = IconColor.Success;
            break;
        case CategoryFormMode.Locations:
            Title = "Locations";
            icon = IconName.MapFill;
            buttonText = "Location";
            break;
        case CategoryFormMode.Departments:
            Title = "Departments";
            icon = IconName.BuildingFill;
            buttonText = "Department";
            color = IconColor.Info;
            break;
        case CategoryFormMode.Rooms:
            Title = "Rooms";
            icon = IconName.MapFill;
            buttonText = "Room";
            color = IconColor.Secondary;
            roomsList = (await locationService.GetAllRoomsAsync()).ToList();
            break;
    }

}


private async Task hideEditFormDialog(){
    showEditForm = false;
    await Task.CompletedTask;
}

void showEditFormDialog(int id){
    Id = id;
    showEditForm = true;
}

private async Task ChangeTitle(string title){
    switch (Type)
    {
        case CategoryFormMode.Types:
            typeService.ChangeName(Id,title);
            break;
        case CategoryFormMode.Conditions:

            break;
        case CategoryFormMode.Locations:

            break;
        case CategoryFormMode.Departments:

            break;
    }
    await Task.Delay(10);
    navigation.Refresh();
}

private async Task CreateRoom()
{
    if (string.IsNullOrWhiteSpace(newRoomName)) return;
    var room = new Room { RoomName = newRoomName };
    await locationService.CreateRoomAsync(room);
    newRoomName = string.Empty;
    showRoomForm = false;
    roomsList = (await locationService.GetAllRoomsAsync()).ToList();
    StateHasChanged();
}

private async Task DeleteRoom(int id)
{
    try
    {
        await locationService.DeleteRoomAsync(id);
        roomsList = (await locationService.GetAllRoomsAsync()).ToList();
        StateHasChanged();
    }
    catch (Exception ex)
    {
        Console.Error.WriteLine(ex.Message);
    }
}

private void EditRoom(int id)
{
    navigation.NavigateTo($"/categories/Edit-Room/{id}");
}

private void NavigateToNewDepartment()
{
    navigation.NavigateTo("/categories/Edit-Department");
}

}
