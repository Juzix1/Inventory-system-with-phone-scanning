@using InventoryLibrary.Model.Inventory
@using InventoryLibrary.Services
@using InventoryLibrary.Services.Interfaces
@using InventoryWeb.Models
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.EntityFrameworkCore.Metadata.Internal
@using Microsoft.IdentityModel.Tokens

@inject ILogger<BaseEditForm> Logger
@inject IInventoryService inventoryService
@inject IConditionService conditionService;
@inject NavigationManager navigationManager
@inject IImageService imageService
@inject IJSRuntime JS
@inject ILocationService locationService
@inject ISettingsService SettingsService
@inject IAccountsService accountsService

<EditForm Model="@Model" OnValidSubmit="Submit" FormName="BaseEditForm">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <div>
        <label>Item Name</label>
        <InputText @bind-Value="Model.itemName" class="form-control" />
    </div>
    <div>
        <label>Description</label>
        <InputTextArea @bind-Value="Model.itemDescription" class="form-control" />
    </div>
    <div>
        <label>Model Name</label>
        <InputText @bind-Value="Model.ModelName" class="form-control" />
    </div>
    <div>
        <label>Cpu</label>
        <InputText @bind-Value="Model.CPU" class="form-control" />
    </div>
    <div>
        <label>Ram</label>
        <InputText @bind-Value="Model.RAM" class="form-control" />
    </div>
    <div>
        <label>Storage</label>
        <InputText @bind-Value="Model.Storage" class="form-control" />
    </div>
    <div>
        <label>Graphics Card</label>
        <InputText @bind-Value="Model.Graphics" class="form-control" />
    </div>
    <div>
        <label>Item's Condition</label>
        <InputSelect @bind-Value="Model.ItemConditionId" class="form-control">
            <option value="">Select Condition</option>
            @foreach (var cond in conditions)
            {
                <option value="@cond.Id">@cond.ConditionName</option>
            }
        </InputSelect>
    </div>

    <div>
        <label>Weight</label>
        <InputNumber @bind-Value="Model.itemWeight" class="form-control" />
    </div>
    <div>
        <label>Price</label>
        <InputNumber @bind-Value="Model.itemPrice" class="form-control" />
    </div>
    <div>
        <label>End of Warranty</label>
        <InputDate @bind-Value="Model.warrantyEnd" class="form-control" />
    </div>
    <div class="form-group image-upload">
        <label>Item Image (optional):</label>
        <InputFile id="@fileInputId" OnChange="HandleImageSend" accept="image/*" class="form-control" />

    </div>
    <label>Assign to Person</label>
    <div class="position-relative">
        <InputText Value="@personSearchQuery" ValueExpression="@(() => personSearchQuery)" @oninput="HandlePersonSearch"
            class="form-control" placeholder="Enter index number or name" />

        @if (showPersonSuggestions && personSuggestions.Any())
        {
            <div class="suggestions-dropdown">
                @foreach (var person in personSuggestions)
                {
                    <div class="suggestion-item" @onclick="() => SelectPerson(person)">
                        <strong>@person.IndexNumber</strong> - @person.FullName
                    </div>
                }
            </div>
        }
    </div>

    @if (selectedPerson != null)
    {
        <div class="selected-person mt-2">
            <span class="badge bg-primary">
                @selectedPerson.IndexNumber - @selectedPerson.FullName
                <button type="button" class="btn-close btn-close-white ms-2" @onclick="ClearSelectedPerson"
                    aria-label="CLear"></button>
            </span>
        </div>
    }
    <div>
        <label>Room</label>
        <InputSelect @bind-Value="Model.RoomId" class="form-control">
            <option value="">Select room</option>
            @foreach (var r in rooms)
            {
                <option value="@r.Id">@r.RoomName</option>
            }
        </InputSelect>
    </div>

    <div class="itemForm_buttons">
        <div class="mt-3">
            <button type="submit" class="btn btn-primary">Submit</button>
        </div>
        <div class="mt-3">
            <button type="button" class="btn btn-secondary" @onclick="CancelClicked">Cancel</button>
        </div>
    </div>

</EditForm>

@code {
    private bool IsUpdating = false;
    private string imagePreview = string.Empty;
    private string errorMessage = string.Empty;
    private bool isSubmitting;
    private string fileInputId = "";
    [Parameter]
    public int itemTypeId { get; set; }
    [Parameter]
    public EventCallback<Task> OnCancel { get; set; }
    [Parameter]
    public AGD Model { get; set; } = new AGD();

    private string oldImagePath = "";
    private string? pendingUploadedImage = null;
    private string? pendingOldImageToDelete = null;

    List<ItemCondition> conditions = new();
    private List<InventoryLibrary.Model.Location.Room> rooms = new();
    private string personSearchQuery = string.Empty;
    private List<PersonDto> personSuggestions = new();
    private bool showPersonSuggestions = false;
    private PersonDto? selectedPerson = null;
    private System.Threading.Timer? searchDebounceTimer;

    protected override async Task OnInitializedAsync()
    {
        if (Model == null)
        {
            throw new ArgumentNullException(nameof(Model), "Model cannot be null. Please provide a valid InventoryItem instance.");
        }
        conditions = (await conditionService.GetAllItemConditions()).ToList();
        oldImagePath = Model.imagePath;

        try
        {
            var settings = await SettingsService.GetSettings();
            var chosen = settings.FirstOrDefault(s => s.Key == "ChosenDepartmentId")?.Value;
            int? chosenId = null;
            if (!string.IsNullOrWhiteSpace(chosen) && int.TryParse(chosen, out var did)) chosenId = did;
            var allRooms = (await locationService.GetAllRoomsAsync()).ToList();
            if (chosenId.HasValue && chosenId.Value > 0)
            {
                rooms = allRooms.Where(r => r.DepartmentId.HasValue && r.DepartmentId.Value == chosenId.Value).ToList();
            }
            else
            {
                rooms = allRooms;
            }
        }
        catch { }

        if (Model?.PersonInChargeId != null)
        {
            var person = await accountsService.GetAccountByIdAsync((int)Model.PersonInChargeId);
            if (person != null)
            {
                personSearchQuery = $"{person.Id} - {person.Name}";
                selectedPerson = new PersonDto
                {
                    Id = person.Id,
                    IndexNumber = person.Id.ToString(),
                    FullName = person.Name
                };
                showPersonSuggestions = false;
            }
        }

        if (Model.itemName.IsNullOrEmpty())
        {
            IsUpdating = false;
            Logger.LogInformation("AGDEditForm initialized for editing item: {ItemName}", Model.itemName);
            Model.ItemTypeId = itemTypeId;
            Model.warrantyEnd = DateTime.Now;
        }
        else
        {
            IsUpdating = true;
        }
        fileInputId = "file_" + Guid.NewGuid().ToString("N");
    }
    private async Task Submit()
    {
        isSubmitting = true;
        errorMessage = string.Empty;
        try
        {
            InventoryItem item;

            if (IsUpdating)
            {
                item = await inventoryService.UpdateItemAsync(Model);
            }
            else
            {
                item = await inventoryService.CreateItemAsync(Model);
            }
            if (!string.IsNullOrEmpty(pendingOldImageToDelete))
            {
                await imageService.DeleteImageAsync(pendingOldImageToDelete);
                pendingOldImageToDelete = null;
            }

            pendingUploadedImage = null;

            navigationManager.NavigateTo("/manage");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error {(IsUpdating ? "updating" : "creating")} item: {ex}\n";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task CancelClicked()
    {
        try
        {
            if (!string.IsNullOrEmpty(pendingUploadedImage) && pendingUploadedImage != oldImagePath)
            {
                await imageService.DeleteImageAsync(pendingUploadedImage);
            }
        }
        catch { }

        Model.imagePath = oldImagePath;
        pendingUploadedImage = null;
        pendingOldImageToDelete = null;

        await OnCancel.InvokeAsync();
    }

    private async Task HandleImageSend(InputFileChangeEventArgs e)
    {
        var file = e.File;

        if (file == null)
            return;

        const long maxFileSize = 5 * 1024 * 1024;
        if (file.Size > maxFileSize)
        {

            return;
        }
        try
        {

            using var stream = file.OpenReadStream(maxFileSize);
            var result = await imageService.SendImageAsync(stream, file.Name);

            if (result.Success)
            {
                pendingUploadedImage = result.ImageId;

                if (!string.IsNullOrEmpty(Model.imagePath) && Model.imagePath != pendingUploadedImage)
                {
                    pendingOldImageToDelete = Model.imagePath;
                }

                Model.imagePath = result.ImageId;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Upload error: {ex.Message}");
        }

    }

    private async Task HandlePersonSearch(ChangeEventArgs e)
    {
        personSearchQuery = e.Value?.ToString() ?? string.Empty;
        searchDebounceTimer?.Dispose();

        if (string.IsNullOrWhiteSpace(personSearchQuery))
        {
            showPersonSuggestions = false;
            personSuggestions.Clear();
            return;
        }

        searchDebounceTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
    {
            await SearchPersons();
            StateHasChanged();
        });
        }, null, 300, Timeout.Infinite);
    }

    private async Task SearchPersons()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(personSearchQuery))
            {
                personSuggestions.Clear();
                showPersonSuggestions = false;
                return;
            }

            var accounts = (await accountsService.GetAllAccountsAsync())
            .Where(a => a.Id.ToString().Contains(personSearchQuery) ||
            (a.Name?.Contains(personSearchQuery, StringComparison.OrdinalIgnoreCase) ?? false))
            .Take(10)
            .Select(a => new PersonDto
            {
                Id = a.Id,
                IndexNumber = a.Id.ToString(),
                FullName = a.Name
            })
            .ToList();

            personSuggestions = accounts;
            showPersonSuggestions = personSuggestions.Any();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error searching persons: {ex.Message}");
            errorMessage = "Failed to search persons";
        }
    }

    private void SelectPerson(PersonDto person)
    {
        selectedPerson = person;
        personSearchQuery = $"{person.IndexNumber} - {person.FullName}";
        showPersonSuggestions = false;
        Model.PersonInChargeId = person.Id;
    }

    private void ClearSelectedPerson()
    {
        selectedPerson = null;
        personSearchQuery = string.Empty;
        Model.PersonInChargeId = null;
    }

    public void Dispose()
    {
        searchDebounceTimer?.Dispose();
    }

    


}