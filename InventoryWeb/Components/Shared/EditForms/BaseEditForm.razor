@using InventoryLibrary.Model.Inventory
@using InventoryLibrary.Services
@using InventoryLibrary.Services.Interfaces
@using InventoryLibrary.Services.data
@using Microsoft.IdentityModel.Tokens
@inject ILogger<BaseEditForm> Logger
@inject IInventoryService inventoryService
@inject IConditionService conditionService
@inject NavigationManager navigationManager
@inject IImageService imageService
@inject IAccountsService accountsService

@inject IJSRuntime JS
@inject InventoryLibrary.Services.Interfaces.ILocationService locationService
@inject InventoryLibrary.Services.Interfaces.ISettingsService SettingsService
@using Microsoft.AspNetCore.Components.Forms



<PageTitle>Edit Inventory Item</PageTitle>

<EditForm Model="Model" OnValidSubmit="Submit" OnInvalidSubmit="HandleInvalidSubmit" FormName="BaseEditForm">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div>
        <label>Item Name</label>
        <InputText @bind-Value="Model.itemName" class="form-control" />
    </div>


    <div>
        <label>Description</label>
        <InputTextArea @bind-Value="Model.itemDescription" class="form-control" />
    </div>

    <div>
        <label>Item's Condition</label>
        <InputSelect @bind-Value="Model.ItemConditionId" class="form-control">
            <option value="">Select Condition</option>
            @foreach (var cond in conditions)
            {
                <option value="@cond.Id">@cond.ConditionName</option>
            }
        </InputSelect>
    </div>

    <div>
        <label>Weight</label>
        <InputNumber @bind-Value="Model.itemWeight" class="form-control" />
    </div>

    <div>
        <label>Price</label>
        <CurrencyInput TValue="double" @bind-Value="Model.itemPrice" Placeholder="Enter amount" Locale="en-PL" />
    </div>

    <div>
        <label>End of Warranty</label>
        <InputDate @bind-Value="Model.warrantyEnd" class="form-control" />
    </div>
    <div class="form-group image-upload">
        <label>Item Image (optional):</label>
        <InputFile id="@fileInputId" OnChange="HandleImageSend" accept="image/*" class="form-control" />
    </div>
    <div class="mt-3">
        <label>Assign to Person</label>
        <div class="position-relative">
            <InputText Value="@personSearchQuery" ValueExpression="@(() => personSearchQuery)"
                @oninput="HandlePersonSearch" class="form-control" placeholder="Enter index number or name" />

            @if (showPersonSuggestions && personSuggestions.Any())
            {
                <div class="suggestions-dropdown">
                    @foreach (var person in personSuggestions)
                    {
                        <div class="suggestion-item" @onclick="() => SelectPerson(person)">
                            <strong>@person.IndexNumber</strong> - @person.FullName
                        </div>
                    }
                </div>
            }
        </div>

        @if (selectedPerson != null)
        {
            <div class="selected-person mt-2">
                <span class="badge bg-primary">
                    @selectedPerson.IndexNumber - @selectedPerson.FullName
                    <button type="button" class="btn-close btn-close-white ms-2" @onclick="ClearSelectedPerson"
                        aria-label="CLear"></button>
                </span>
            </div>
        }
        <div>
        <label>Room</label>
        <InputSelect @bind-Value="Model.RoomId" class="form-control">
            <option value="">Select room</option>
            @foreach (var r in rooms)
            {
                <option value="@r.Id">@r.RoomName</option>
            }
        </InputSelect>
    </div>
    </div>


    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger mt-3">@errorMessage</div>
    }

    <div class="itemForm_buttons">
        <div class="mt-3">
            <button type="submit" class="btn btn-primary" disabled="@isSubmitting">
                @(isSubmitting ? "Saving..." : "Submit")
            </button>
        </div>
        <div class="mt-3">
            <button type="button" class="btn btn-secondary" @onclick="CancelClicked" disabled="@isSubmitting">
                Cancel
            </button>
        </div>

    </div>
</EditForm>

@code {
    private bool IsUpdating = false;
    [Parameter]
    public int itemTypeId { get; set; }

    [Parameter]
    public EventCallback<Task> OnCancel { get; set; }

    [Parameter]
    public InventoryItem Model { get; set; } = new InventoryItem();

    private List<ItemCondition> conditions = new();
    private List<InventoryLibrary.Model.Location.Room> rooms = new();
    private int? chosenDepartmentId = null;
    private IBrowserFile? selectedFile;
    private string errorMessage = string.Empty;
    private bool isSubmitting;
    private string fileInputId = "";
    private string oldImagePath = "";
    private string? pendingUploadedImage = null;
    private string? pendingOldImageToDelete = null;

    private string personSearchQuery = string.Empty;
    private List<PersonDto> personSuggestions = new();
    private bool showPersonSuggestions = false;
    private PersonDto? selectedPerson = null;
    private System.Threading.Timer? searchDebounceTimer;

    private async Task HandlePersonSearch(ChangeEventArgs e)
    {
        personSearchQuery = e.Value?.ToString() ?? string.Empty;

        // Debounce the search
        searchDebounceTimer?.Dispose();

        if (string.IsNullOrWhiteSpace(personSearchQuery))
        {
            showPersonSuggestions = false;
            personSuggestions.Clear();
            return;
        }

        searchDebounceTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
    {
            await SearchPersons();
            StateHasChanged();
        });
        }, null, 300, Timeout.Infinite);
    }

    private async Task SearchPersons()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(personSearchQuery))
            {
                personSuggestions.Clear();
                showPersonSuggestions = false;
                return;
            }

            var accounts = (await accountsService.GetAllAccountsAsync())
            .Where(a => a.Id.ToString().Contains(personSearchQuery) ||
            (a.Name?.Contains(personSearchQuery, StringComparison.OrdinalIgnoreCase) ?? false))
            .Take(10)
            .Select(a => new PersonDto
            {
                Id = a.Id,
                IndexNumber = a.Id.ToString(),
                FullName = a.Name
            })
            .ToList();

            personSuggestions = accounts;
            showPersonSuggestions = personSuggestions.Any();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error searching persons: {ex.Message}");
            errorMessage = "Failed to search persons";
        }
    }

    private void SelectPerson(PersonDto person)
    {
        selectedPerson = person;
        personSearchQuery = $"{person.IndexNumber} - {person.FullName}";
        showPersonSuggestions = false;
        Model.PersonInChargeId = person.Id;
    }

    private void ClearSelectedPerson()
    {
        selectedPerson = null;
        personSearchQuery = string.Empty;
        Model.PersonInChargeId = null;
    }

    public void Dispose()
    {
        searchDebounceTimer?.Dispose();
    }

    // DTO class
    public class PersonDto
    {
        public int Id { get; set; }
        public string IndexNumber { get; set; } = string.Empty; // This will display the ID as string
        public string FullName { get; set; } = string.Empty;
    }
    /////


    protected override async Task OnInitializedAsync()
    {
        if (Model == null)
        {
            throw new ArgumentNullException(nameof(Model), "Model cannot be null. Please provide a valid InventoryItem instance.");
        }

        conditions = (await conditionService.GetAllItemConditions()).ToList();
        oldImagePath = Model.imagePath;

        // Load chosen department ID from settings and rooms for that department
        try
        {
            var settings = await SettingsService.GetSettings();
            var chosen = settings.FirstOrDefault(s => s.Key == "ChosenDepartmentId")?.Value;
            if (!string.IsNullOrWhiteSpace(chosen) && int.TryParse(chosen, out var did))
            {
                chosenDepartmentId = did;
            }

            var allRooms = (await locationService.GetAllRoomsAsync()).ToList();
            if (chosenDepartmentId.HasValue && chosenDepartmentId.Value > 0)
            {
                rooms = allRooms.Where(r => r.DepartmentId.HasValue && r.DepartmentId.Value == chosenDepartmentId.Value).ToList();
            }
            else
            {
                rooms = allRooms;
            }
        }
        catch { }


        if (Model?.PersonInChargeId != null)
        {
            var person = await accountsService.GetAccountByIdAsync((int)Model.PersonInChargeId);
            if (person != null)
            {
                personSearchQuery = $"{person.Id} - {person.Name}";
                selectedPerson = new PersonDto
                {
                    Id = person.Id,
                    IndexNumber = person.Id.ToString(),
                    FullName = person.Name
                };
                showPersonSuggestions = false;
            }
        }

        // Check if this is an update or create
        if (!string.IsNullOrEmpty(Model.itemName) && Model.Id > 0)
        {
            IsUpdating = true;

            Logger.LogInformation("BaseEditForm initialized for editing item: {ItemName} (ID: {ItemId})", Model.itemName, Model.Id);
        }
        else
        {
            IsUpdating = false;
            Logger.LogInformation("BaseEditForm initialized for creating new item");
            Model.ItemTypeId = itemTypeId;
            Model.addedDate = DateTime.Now;
            Model.warrantyEnd = DateTime.Now.AddYears(1);
            Model.lastInventoryDate = DateTime.Now;
        }
        fileInputId = "file_" + Guid.NewGuid().ToString("N");
    }

    private async Task HandleImageSend(InputFileChangeEventArgs e)
    {
        var file = e.File;

        if (file == null)
            return;

        const long maxFileSize = 5 * 1024 * 1024;
        if (file.Size > maxFileSize)
        {
            return;
        }
        try
        {
            using var stream = file.OpenReadStream(maxFileSize);
            var result = await imageService.SendImageAsync(stream, file.Name);

            if (result.Success)
            {
                // Keep uploaded image locally until user confirms save.
                pendingUploadedImage = result.ImageId;

                // If there was an existing image and it's different, schedule it for deletion after successful save
                if (!string.IsNullOrEmpty(Model.imagePath) && Model.imagePath != pendingUploadedImage)
                {
                    pendingOldImageToDelete = Model.imagePath;
                }

                Model.imagePath = result.ImageId;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Upload error: {ex.Message}");
        }

    }
    private async Task Submit()
    {
        isSubmitting = true;
        errorMessage = string.Empty;
        Logger.LogInformation("Submit invoked. IsUpdating={IsUpdating}, ItemName={ItemName}", IsUpdating, Model?.itemName);

        try
        {
            InventoryItem item;

            if (IsUpdating)
            {
                item = await inventoryService.UpdateItemAsync(Model);
            }
            else
            {
                item = await inventoryService.CreateItemAsync(Model);
            }


            
            // After successful save, delete previously replaced image (if any)
            if (!string.IsNullOrEmpty(pendingOldImageToDelete))
            {
                await imageService.DeleteImageAsync(pendingOldImageToDelete);
                pendingOldImageToDelete = null;
            }

            // clear pending uploaded marker
            pendingUploadedImage = null;

            navigationManager.NavigateTo("/manage");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error {(IsUpdating ? "updating" : "creating")} item: {ex}\n";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void HandleInvalidSubmit(EditContext editContext)
    {
        isSubmitting = false;
        errorMessage = "Form validation failed. Please check required fields.";
        Logger.LogWarning("Form invalid on submit. Validation messages count: {Count}",
        editContext.GetValidationMessages().Count());
    }

    private async Task CancelClicked()
    {
        try
        {
            if (!string.IsNullOrEmpty(pendingUploadedImage) && pendingUploadedImage != oldImagePath)
            {
                await imageService.DeleteImageAsync(pendingUploadedImage);
            }
            else if (!string.IsNullOrEmpty(Model.imagePath) && Model.imagePath != oldImagePath && pendingUploadedImage == null)
            {
                await imageService.DeleteImageAsync(Model.imagePath);
            }
        }
        catch { }
        
        Model.imagePath = oldImagePath;
        pendingUploadedImage = null;
        pendingOldImageToDelete = null;

        await OnCancel.InvokeAsync();
    }

}