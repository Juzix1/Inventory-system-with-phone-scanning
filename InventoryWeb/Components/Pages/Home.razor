@page "/"
@using InventoryLibrary.Model.DTO
@using InventoryLibrary.Model.Data
@using InventoryLibrary.Services
@using InventoryLibrary.Services.Interfaces
@using Microsoft.AspNetCore.Authorization
@using BlazorBootstrap
@attribute [Authorize(Roles = "Admin")]
@inject IAnalyticsService analyticsService
@inject ISettingsService settingsService
@rendermode InteractiveServer

<PageTitle>Dashboard - Analytics</PageTitle>

@if (isLoading)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else if (hasError)
{
    <div class="alert alert-danger">
        <h3>No connection with Database</h3>
    </div>
}
else
{
    <div class="container-fluid pt-3">
        <!-- Key Metrics Row -->
        <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-3">
                <SmallBoxStat Title="Total Items" value="@stats.TotalItems.ToString()" Icon=IconName.Box2Fill
                    color="#0fb5ae" />
            </div>
            <div class="col-xl-3 col-md-6 mb-3">
                <SmallBoxStat Title="Broken Items" value="@stats.BrokenItems.ToString()" Icon=IconName.XCircleFill />
            </div>
            <div class="col-xl-3 col-md-6 mb-3">
                <SmallBoxStat Title="Items on Loan" value="@stats.ItemsOnLoan.ToString()" Icon=IconName.PersonCheck
                    color="#F34213" />
            </div>
            <div class="col-xl-3 col-md-6 mb-3">
                <SmallBoxStat Title="Total Users" value="@stats.TotalUsers.ToString()" Icon=IconName.People
                    color="#644C94" />
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-3">
                <SmallBoxStat Title="Total Value" value="@($"{stats.AllDepartmentsValue:N2} PLN")" Icon=IconName.CurrencyDollar
                    color="#0fb5ae" />
            </div>
            <div class="col-xl-3 col-md-6 mb-3">
                <SmallBoxStat Title="Department Value" value="@($"{stats.DepartmentValue:N2} PLN")"
                    Icon=IconName.Building />
            </div>
            <div class="col-xl-3 col-md-6 mb-3">
                <SmallBoxStat Title="Items without Review" value="@stats.ItemsWithoutReview.ToString()"
                    Icon=IconName.ExclamationTriangle color="#F34213" />
            </div>
            <div class="col-xl-3 col-md-6 mb-3">
                <SmallBoxStat Title="Avg Item Age" value="@($"{stats.AverageItemAge:N1} months")" Icon=IconName.Calendar
                    color="#644C94" />
            </div>
        </div>
    </div>

    <div class="container-fluid mb-4">
        <div class="d-flex justify-content-around">
            <LineChartStat Title="Items Created Per Month" ChartData="@itemsCreatedChartData"
                ChartOptions="@itemsCreatedOptions" />
            <LineChartStat Title="Asset Value Trend" ChartData="@assetValueChartData" ChartOptions="@assetValueOptions" />
        </div>
    </div>
    <div class="container-fluid mb-4">
        <div class="d-flex justify-content-around">

            <PieChartStat Title="Items by Category" ChartData="@categoryPieChartData" ChartOptions="@categoryPieOptions" />

            <PieChartStat Title="Item Condition Distribution" ChartData="@conditionPieChartData"
                ChartOptions="@conditionPieOptions" />
        </div>
    </div>
    <div class="container-fluid mb-4">
        <div class="d-flex justify-content-around">
            <LineChartStat Title="Monthly Item Loss (Historical)" ChartData="@itemLossChartData"
                ChartOptions="@itemLossOptions" />

            <BarChartStat Title="Items Without Inventory Review" ChartData="@withoutInventoryChartData"
                ChartOptions="@withoutInventoryOptions" />
        </div>
    </div>
    <div class="d-flex justify-content-center">
        <div class="row mb-4 px-2 w-75">
            <div class="col-12 w-100">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">All Departments Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="row d-flex justify-content-around">
                            <div class="col-md-3">
                                <h6>Monthly Item Creation</h6>
                                <p class="mb-0">Total Created: <strong>@monthlyItemsData?.TotalCreated</strong></p>
                                <p class="mb-0">Average per Month: <strong>@($"{monthlyItemsData?.AveragePerMonth:N1}")</strong></p>
                            </div>
                            <div class="col-md-3">
                                <h6>Item Loss Analysis</h6>
                                <p class="mb-0">Total Lost Items: <strong class="text-danger">@itemLossData?.TotalLost</strong></p>
                                <p class="mb-0">Value Lost: <strong class="text-danger">@($"{itemLossData?.TotalValueLost:N2}                                PLN")</strong></p>
                            </div>
                            <div class="col-md-3">
                                <h6>Inventory Status</h6>
                                <p class="mb-0">Items needing Review: <strong
                                        class="text-warning">@withoutInventoryData?.TotalOverdue</strong></p>
                                <p class="mb-0">Categories: <strong>@categoryData?.TotalCategories</strong></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Critical Items Alert -->
    @if (withoutInventoryData?.CriticalItems?.Any() == true)
    {
        <div class="row mb-4 px-2">
            <div class="col-12">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><Icon Name="IconName.ExclamationTriangleFill"/>Overdue for Inventory Review</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Item Name</th>
                                        <th>Category</th>
                                        <th>Last Inventory</th>
                                        <th>Days Overdue</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in withoutInventoryData.CriticalItems.Take(5))
                                    {
                                        <tr>
                                            <td>@item.ItemName</td>
                                            <td>@item.Category</td>
                                            <td>@item.LastInventoryDate.ToString("dd MMM yyyy")</td>
                                            <td><span class="badge bg-danger">@item.DaysSinceInventory days</span></td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Top Lost Categories -->
    @if (itemLossData?.TopLostCategories?.Any() == true)
    {
        <div class="row mb-4 px-2">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Top Categories by Item Loss</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Items Lost</th>
                                        <th>Value Lost</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var category in itemLossData.TopLostCategories)
                                    {
                                        <tr>
                                            <td>@category.CategoryName</td>
                                            <td><span class="badge bg-danger">@category.ItemsLost</span></td>
                                            <td>@($"{category.TotalValueLost:N2} PLN")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
}

@code {
    private bool isLoading = true;
    private bool hasError = false;
    private int? chosenDepartmentId;

    private DashboardStatistics stats = new();
    private MonthlyItemsCreatedData? monthlyItemsData;
    private ItemsByCategoryData? categoryData;
    private ItemsWithoutInventoryData? withoutInventoryData;
    private MonthlyItemLossData? itemLossData;
    private ItemConditionDistributionData? conditionData;
    private AssetValueTrendData? assetValueData;

    // Chart data objects
    private ChartData? itemsCreatedChartData;
    private ChartData? categoryPieChartData;
    private ChartData? withoutInventoryChartData;
    private ChartData? itemLossChartData;
    private ChartData? conditionPieChartData;
    private ChartData? assetValueChartData;

    // Chart options
    private LineChartOptions? itemsCreatedOptions;
    private PieChartOptions? categoryPieOptions;
    private BarChartOptions? withoutInventoryOptions;
    private LineChartOptions? itemLossOptions;
    private PieChartOptions? conditionPieOptions;
    private LineChartOptions? assetValueOptions;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
        SetupCharts();
    }

    private async Task LoadDataAsync()
    {
        try
        {
            var deptIdStr = await settingsService.GetSettingValue<string>("ChosenDepartmentId");
            if (!string.IsNullOrEmpty(deptIdStr) && int.TryParse(deptIdStr, out int deptId))
            {
                chosenDepartmentId = deptId;
            }

            stats = await analyticsService.GetDashboardStatistics(chosenDepartmentId);
            monthlyItemsData = await analyticsService.GetMonthlyItemsCreated(chosenDepartmentId);
            categoryData = await analyticsService.GetItemsByCategory(chosenDepartmentId);
            withoutInventoryData = await analyticsService.GetItemsWithoutInventory(chosenDepartmentId);
            itemLossData = await analyticsService.GetMonthlyItemLoss(chosenDepartmentId);
            conditionData = await analyticsService.GetItemConditionDistribution(chosenDepartmentId);
            assetValueData = await analyticsService.GetAssetValueTrend(chosenDepartmentId);

            hasError = false;
        }
        catch (Exception e)
        {
            Console.WriteLine($"Error: {e.Message}");
            hasError = true;
        }
        finally
        {
            isLoading = false;
        }
    }

    private void SetupCharts()
    {
        SetupItemsCreatedChart();
        SetupCategoryPieChart();
        SetupWithoutInventoryChart();
        SetupItemLossChart();
        SetupConditionPieChart();
        SetupAssetValueChart();
    }

    private void SetupItemsCreatedChart()
    {
        if (monthlyItemsData == null) return;

        var colors = ColorUtility.CategoricalTwelveColors;
        var dataset = new LineChartDataset
        {
            Label = "Items Created",
            Data = monthlyItemsData.ItemsCreated.Select(d => (double?)d).ToList(),
            BackgroundColor = colors[0],
            BorderColor = colors[0],
            BorderWidth = 2,
            Fill = true,
            Tension = 0.4
        };

        itemsCreatedChartData = new ChartData
        {
            Labels = monthlyItemsData.Labels,
            Datasets = new List<IChartDataset> { dataset }
        };

        itemsCreatedOptions = new LineChartOptions
        {
            Responsive = true,
            Interaction = new Interaction { Mode = InteractionMode.Index }
        };
        itemsCreatedOptions.Scales.X!.Title = new ChartAxesTitle { Text = "Month", Display = true };
        itemsCreatedOptions.Scales.Y!.Title = new ChartAxesTitle { Text = "Number of Items", Display = true };
    }

    private void SetupCategoryPieChart()
    {
        if (categoryData == null || !categoryData.Categories.Any()) return;

        var colors = ColorUtility.CategoricalTwelveColors;
        var dataset = new PieChartDataset
        {
            Label = "Items",
            Data = categoryData.Values.Select(d => (double?)d).ToList(),
            BackgroundColor = colors.Take(categoryData.Values.Count).ToList()
        };

        categoryPieChartData = new ChartData
        {
            Labels = categoryData.Labels,
            Datasets = new List<IChartDataset> { dataset }
        };

        categoryPieOptions = new PieChartOptions
        {
            Responsive = true,
            Plugins = new PieChartPlugins
            {
                Legend = new ChartPluginsLegend { Display = true, Position = "right" }
            }
        };
    }

    private void SetupWithoutInventoryChart()
    {
        if (withoutInventoryData == null) return;

        var colors = ColorUtility.CategoricalTwelveColors;
        var dataset = new BarChartDataset
        {
            Label = "Items Count",
            Data = withoutInventoryData.Values.Select(d => (double?)d).ToList(),
            BackgroundColor = new List<string> { colors[1], colors[4], colors[6], colors[3], colors[8] }
        };

        withoutInventoryChartData = new ChartData
        {
            Labels = withoutInventoryData.Labels,
            Datasets = new List<IChartDataset> { dataset }
        };

        withoutInventoryOptions = new BarChartOptions
        {
            Responsive = true,
            Interaction = new Interaction { Mode = InteractionMode.Index }
        };
        withoutInventoryOptions.Scales.Y!.Title = new ChartAxesTitle { Text = "Number of Items", Display = true };
    }

    private void SetupItemLossChart()
    {
        if (itemLossData == null) return;

        var colors = ColorUtility.CategoricalTwelveColors;
        var datasets = new List<IChartDataset>
{
new LineChartDataset
{
Label = "Items Lost",
Data = itemLossData.ItemsLost.Select(d => (double?)d).ToList(),
BackgroundColor = colors[3],
BorderColor = colors[3],
BorderWidth = 2,
YAxisID = "y"
},
new LineChartDataset
{
Label = "Value Lost (PLN)",
Data = itemLossData.ValueLost.Select(d => (double?)d).ToList(),
BackgroundColor = colors[8],
BorderColor = colors[8],
BorderWidth = 2,
YAxisID = "y1"
}
};

        itemLossChartData = new ChartData
        {
            Labels = itemLossData.Labels,
            Datasets = datasets
        };

        itemLossOptions = new LineChartOptions
        {
            Responsive = true,
            Interaction = new Interaction { Mode = InteractionMode.Index }
        };
        itemLossOptions.Scales.Y!.Title = new ChartAxesTitle { Text = "Items Lost", Display = true };
    }

    private void SetupConditionPieChart()
    {
        if (conditionData == null || !conditionData.Conditions.Any()) return;

        var colors = ColorUtility.CategoricalTwelveColors;
        var dataset = new PieChartDataset
        {
            Label = "Items",
            Data = conditionData.Values.Select(d => (double?)d).ToList(),
            BackgroundColor = colors.Take(conditionData.Values.Count).ToList()
        };

        conditionPieChartData = new ChartData
        {
            Labels = conditionData.Labels,
            Datasets = new List<IChartDataset> { dataset }
        };

        conditionPieOptions = new PieChartOptions
        {
            Responsive = true,
            Plugins = new PieChartPlugins
            {
                Legend = new ChartPluginsLegend { Display = true, Position = "right" }
            }
        };
    }

    private void SetupAssetValueChart()
    {
        if (assetValueData == null) return;

        var colors = ColorUtility.CategoricalTwelveColors;
        var dataset = new LineChartDataset
        {
            Label = "Total Value (PLN)",
            Data = assetValueData.Values.Select(d => (double?)d).ToList(),
            BackgroundColor = colors[2],
            BorderColor = colors[2],
            BorderWidth = 2,
            Fill = true,
            Tension = 0.4
        };

        assetValueChartData = new ChartData
        {
            Labels = assetValueData.Labels,
            Datasets = new List<IChartDataset> { dataset }
        };

        assetValueOptions = new LineChartOptions
        {
            Responsive = true,
            Interaction = new Interaction { Mode = InteractionMode.Index }
        };
        assetValueOptions.Scales.X!.Title = new ChartAxesTitle { Text = "Month", Display = true };
        assetValueOptions.Scales.Y!.Title = new ChartAxesTitle { Text = "Value (PLN)", Display = true };
    }
}