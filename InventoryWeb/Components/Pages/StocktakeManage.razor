@page "/stocktake-management"
@using InventoryLibrary.Model.Accounts
@using InventoryLibrary.Model.Inventory
@using InventoryLibrary.Model.StockTake
@using InventoryLibrary.Services.Interfaces
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin")]

@inject IInventoryService InventoryService
@inject IStocktakeService StocktakeService
@inject IAccountsService AccountsService
@inject NavigationManager NavigationManager

@rendermode InteractiveServer

<PageTitle>Zarządzanie Inwentaryzacją</PageTitle>

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="bi bi-clipboard-check"></i> Stocktake process management</h2>
        </div>
        <button class="btn btn-primary btn-lg" @onclick="ShowCreateModal">
            <i class="bi bi-plus-circle"></i> New Stocktake
        </button>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else
    {
        <!-- Statystyki KPI -->
        <div class="row g-3 mb-4">
            <div class="col-xl-3 col-md-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body d-flex align-items-center">
                        <div class="flex-shrink-0 bg-primary bg-opacity-10 rounded-3 p-3">
                            <i class="bi bi-clipboard-data fs-3 text-primary"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <p class="text-muted mb-1 small">All</p>
                            <h3 class="mb-0">@allStocktakes.Count</h3>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body d-flex align-items-center">
                        <div class="flex-shrink-0 bg-warning bg-opacity-10 rounded-3 p-3">
                            <i class="bi bi-hourglass-split fs-3 text-warning"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <p class="text-muted mb-1 small">In Progress</p>
                            <h3 class="mb-0">@allStocktakes.Count(s => s.Status == StockTakeStatus.InProgress)</h3>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body d-flex align-items-center">
                        <div class="flex-shrink-0 bg-success bg-opacity-10 rounded-3 p-3">
                            <i class="bi bi-check-circle fs-3 text-success"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <p class="text-muted mb-1 small">Completed</p>
                            <h3 class="mb-0">@allStocktakes.Count(s => s.Status == StockTakeStatus.Completed)</h3>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body d-flex align-items-center">
                        <div class="flex-shrink-0 bg-info bg-opacity-10 rounded-3 p-3">
                            <i class="bi bi-percent fs-3 text-info"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <p class="text-muted mb-1 small">Effectiveness</p>
                            <h3 class="mb-0">@GetCompletionRate()%</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtry -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label small">Status</label>
                        <select class="form-select" @onchange="e => FilterByStatus(ParseStatus(e.Value?.ToString()))">
                            <option value="">All</option>
                            <option value="@StockTakeStatus.Planned">Planned</option>
                            <option value="@StockTakeStatus.InProgress">In Progress</option>
                            <option value="@StockTakeStatus.Completed">Completed</option>
                            <option value="@StockTakeStatus.Cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small">Date from</label>
                        <input type="date" class="form-control" @bind="filterDateFrom" @bind:after="ApplyFilters" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small">Date to</label>
                        <input type="date" class="form-control" @bind="filterDateTo" @bind:after="ApplyFilters" />
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-secondary w-100" @onclick="ResetFilters">
                            <i class="bi bi-arrow-counterclockwise"></i> Reset
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista inwentaryzacji -->
        <div class="row g-3 mb-4">
            @foreach (var stocktake in filteredStocktakes)
            {
                <div class="col-xl-4 col-lg-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 text-truncate">@stocktake.Name</h5>
                            <span class="badge @GetStatusBadgeClass(stocktake.Status)">
                                @GetStatusText(stocktake.Status)
                            </span>
                        </div>
                        <div class="card-body">
                            <p class="text-muted small mb-3">@stocktake.Description</p>

                            @{
                                var progress = GetProgress(stocktake);
                            }
                            <div class="mb-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <small>Postęp</small>
                                    <small class="badge bg-light text-dark">@progress%</small>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar @GetProgressBarClass(progress)" 
                                         style="width: @progress%"></div>
                                </div>
                                <small class="text-muted">
                                    @stocktake.CheckedItemIdList.Count / @stocktake.AllItems items 
                                </small>
                            </div>

                            <div class="mb-3 small">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="text-muted">Created:</span>
                                    <span>@stocktake.CreatedDate.ToString("dd.MM.yyyy")</span>
                                </div>
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="text-muted">Start:</span>
                                    <span>@stocktake.StartDate.ToString("dd.MM.yyyy")</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">End:</span>
                                    <span>@stocktake.EndDate.ToString("dd.MM.yyyy")</span>
                                </div>
                            </div>

                            @if (stocktake.Status == StockTakeStatus.InProgress)
                            {
                                var timeLeft = stocktake.EndDate - DateTime.Now;
                                <div class="alert @GetTimeLeftAlertClass(timeLeft) py-2 mb-3">
                                    <strong>@GetTimeLeftText(timeLeft)</strong>
                                </div>
                            }

                            <div class="btn-group w-100">
                                <button class="btn btn-sm btn-outline-primary" 
                                        @onclick="() => ViewDetails(stocktake.Id)">
                                    <i class="bi bi-eye"></i> Details
                                </button>
                                @if (stocktake.Status == StockTakeStatus.Planned)
                                {
                                    <button class="btn btn-sm btn-outline-success" 
                                            @onclick="() => StartStocktake(stocktake.Id)">
                                        <i class="bi bi-play-circle"></i> Start
                                    </button>
                                }
                                @if (stocktake.Status == StockTakeStatus.InProgress)
                                {
                                    <button class="btn btn-sm btn-outline-success" 
                                            @onclick="() => CompleteStocktake(stocktake.Id)">
                                        <i class="bi bi-check-circle"></i> End
                                    </button>
                                }
                                @if (stocktake.Status != StockTakeStatus.Completed)
                                {
                                    <button class="btn btn-sm btn-outline-danger" 
                                            @onclick="() => ShowCancelConfirm(stocktake.Id)">
                                        <i class="bi bi-x-circle"></i> Cancel
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Przedmioty wymagające inwentaryzacji -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="bi bi-exclamation-triangle text-warning"></i> 
                    Items Needing Inventory Check
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>name</th>
                                <th>Location</th>
                                <th>Last inventory</th>
                                <th>Days</th>
                                <th>Priority</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in itemsNeedingCheck.Take(10))
                            {
                                var days = (DateTime.Now - item.lastInventoryDate).Days;
                                <tr class="@GetRowClass(days)">
                                    <td>@item.itemName</td>
                                    <td>@(item.Location?.RoomName ?? "Brak")</td>
                                    <td>@item.lastInventoryDate.ToString("dd.MM.yyyy")</td>
                                    <td><span class="badge @GetDaysBadgeClass(days)">@days</span></td>
                                    <td><span class="badge @GetPriorityBadgeClass(days)">@GetPriorityText(days)</span></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>

<!-- Modal tworzenia -->
@if (showCreateModal)
{
    <div class="modal show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">New Stocktake - Step @createStep/3</h5>
                    <button type="button" class="btn-close" @onclick="HideCreateModal"></button>
                </div>
                <div class="modal-body">
                    @if (createStep == 1)
                    {
                        <div class="mb-3">
                            <label class="form-label">Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" @bind="newStocktake.Name" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" @bind="newStocktake.Description"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <label class="form-label">Start <span class="text-danger">*</span></label>
                                <input type="datetime-local" class="form-control" @bind="newStocktake.StartDate" />
                            </div>
                            <div class="col-6">
                                <label class="form-label">End <span class="text-danger">*</span></label>
                                <input type="datetime-local" class="form-control" @bind="newStocktake.EndDate" />
                            </div>
                        </div>
                    }
                    @if (createStep == 2)
                    {
                        <div class="mb-3">
                            <label class="form-label">Items filter</label>
                            <select class="form-select" @bind="itemFilterType" @bind:after="UpdateFilteredItems">
                                <option value="all">All (@allItems.Count)</option>
                                <option value="overdue">Overdue (@allItems.Count(i => (DateTime.Now - i.lastInventoryDate).Days > 180))</option>
                                <option value="critical">Critical (@allItems.Count(i => (DateTime.Now - i.lastInventoryDate).Days > 365))</option>
                                <option value="custom">Choose manually</option>
                            </select>
                        </div>
                        @if (itemFilterType == "custom")
                        {
                            <div style="max-height: 300px; overflow-y: auto;" class="border rounded p-2">
                                @foreach (var item in allItems)
                                {
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" 
                                               checked="@selectedItems.Contains(item)"
                                               @onchange="e => ToggleItem(item, (bool)e.Value)" />
                                        <label class="form-check-label">@item.itemName</label>
                                    </div>
                                }
                            </div>
                        }
                        <div class="alert alert-info mt-2">Choosen: @selectedItems.Count</div>
                    }
                    @if (createStep == 3)
                    {
                        <label class="form-label">Authorized employees</label>
                        <div style="max-height: 300px; overflow-y: auto;" class="border rounded p-2">
                            @foreach (var acc in allAccounts)
                            {
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" 
                                           checked="@selectedAccounts.Contains(acc)"
                                           @onchange="e => ToggleAccount(acc, (bool)e.Value)" />
                                    <label class="form-check-label">@acc.Name</label>
                                </div>
                            }
                        </div>
                        <div class="alert alert-info mt-2">Chosen: @selectedAccounts.Count</div>
                    }
                </div>
                <div class="modal-footer">
                    @if (createStep > 1)
                    {
                        <button class="btn btn-secondary" @onclick="PreviousStep">Back</button>
                    }
                    <button class="btn btn-outline-secondary" @onclick="HideCreateModal">Cancel</button>
                    @if (createStep < 3)
                    {
                        <button class="btn btn-primary" @onclick="NextStep">Next</button>
                    }
                    else
                    {
                        <button class="btn btn-success" @onclick="CreateStocktake">Create</button>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool isLoading = true;
    private List<Stocktake> allStocktakes = new();
    private List<Stocktake> filteredStocktakes = new();
    private List<InventoryItem> allItems = new();
    private List<InventoryItem> itemsNeedingCheck = new();
    private List<Account> allAccounts = new();

    private StockTakeStatus? selectedStatus;
    private DateTime? filterDateFrom, filterDateTo;

    private bool showCreateModal;
    private int createStep = 1;
    private Stocktake newStocktake = new() { StartDate = DateTime.Now, EndDate = DateTime.Now.AddDays(7) };
    private string itemFilterType = "all";
    private List<InventoryItem> selectedItems = new();
    private List<Account> selectedAccounts = new();
    private int? selectedLocationId, selectedTypeId;

    private int? cancelStocktakeId;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        try
        {
            allStocktakes = (await StocktakeService.GetAllStocktakesAsync()).ToList();
            allItems = (await InventoryService.GetAllItemsAsync()).ToList();
            allAccounts = (await AccountsService.GetAllAccountsAsync()).ToList();

            itemsNeedingCheck = allItems.OrderBy(x => x.lastInventoryDate).ToList();
            ApplyFilters();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void FilterByStatus(StockTakeStatus? status)
    {
        selectedStatus = status;
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        var query = allStocktakes.AsEnumerable();
        if (selectedStatus.HasValue) query = query.Where(s => s.Status == selectedStatus.Value);
        if (filterDateFrom.HasValue) query = query.Where(s => s.StartDate >= filterDateFrom.Value);
        if (filterDateTo.HasValue) query = query.Where(s => s.EndDate <= filterDateTo.Value);
        filteredStocktakes = query.ToList();
    }

    private void ResetFilters()
    {
        selectedStatus = null;
        filterDateFrom = filterDateTo = null;
        ApplyFilters();
    }

    private StockTakeStatus? ParseStatus(string value) => 
        Enum.TryParse<StockTakeStatus>(value, out var s) ? s : null;

    private int GetProgress(Stocktake s) => 
        s.AllItems == 0 ? 0 : (int)((double)s.CheckedItemIdList.Count / s.AllItems * 100);

    private string GetCompletionRate()
    {
        var total = allStocktakes.Count;
        if (total == 0) return "0";
        var completed = allStocktakes.Count(s => s.Status == StockTakeStatus.Completed);
        return ((double)completed / total * 100).ToString("F0");
    }

    private string GetStatusBadgeClass(StockTakeStatus status) => status switch
    {
        StockTakeStatus.Planned => "bg-info",
        StockTakeStatus.InProgress => "bg-warning",
        StockTakeStatus.Completed => "bg-success",
        StockTakeStatus.Cancelled => "bg-danger",
        _ => "bg-secondary"
    };

    private string GetStatusText(StockTakeStatus status) => status switch
    {
        StockTakeStatus.Planned => "Planned",
        StockTakeStatus.InProgress => "In Progress",
        StockTakeStatus.Completed => "Completed",
        StockTakeStatus.Cancelled => "Cancelled",
        _ => "Unknown"
    };

    private string GetProgressBarClass(int p) => p >= 75 ? "bg-success" : p >= 50 ? "bg-info" : p >= 25 ? "bg-warning" : "bg-danger";

    private string GetTimeLeftAlertClass(TimeSpan t) => t.TotalDays > 2 ? "alert-success" : t.TotalHours > 0 ? "alert-warning" : "alert-danger";

    private string GetTimeLeftText(TimeSpan t)
    {
        if (t.TotalDays > 1) return $"{(int)t.TotalDays} days left";
        if (t.TotalHours > 0) return $"{(int)t.TotalHours} hours left";
        return "Deadline exceeded!";
    }

    private string GetRowClass(int days) => days > 365 ? "table-danger" : days > 180 ? "table-warning" : "";
    private string GetDaysBadgeClass(int days) => days > 365 ? "bg-danger" : days > 180 ? "bg-warning" : "bg-success";
    private string GetPriorityBadgeClass(int days) => days > 365 ? "bg-danger" : days > 180 ? "bg-warning" : "bg-success";
    private string GetPriorityText(int days) => days > 365 ? "Krytyczny" : days > 180 ? "Wysoki" : "Normalny";

    private void ShowCreateModal()
    {
        newStocktake = new() { StartDate = DateTime.Now, EndDate = DateTime.Now.AddDays(7) };
        createStep = 1;
        selectedItems.Clear();
        selectedAccounts.Clear();
        itemFilterType = "all";
        UpdateFilteredItems();
        showCreateModal = true;
    }

    private void HideCreateModal() => showCreateModal = false;

    private void NextStep()
    {
        if (createStep < 3) createStep++;
    }

    private void PreviousStep()
    {
        if (createStep > 1) createStep--;
    }

    private void UpdateFilteredItems()
    {
        selectedItems = itemFilterType switch
        {
            "overdue" => allItems.Where(i => (DateTime.Now - i.lastInventoryDate).Days > 180).ToList(),
            "critical" => allItems.Where(i => (DateTime.Now - i.lastInventoryDate).Days > 365).ToList(),
            "custom" => selectedItems,
            _ => allItems.ToList()
        };
    }

    private void ToggleItem(InventoryItem item, bool selected)
    {
        if (selected) selectedItems.Add(item);
        else selectedItems.Remove(item);
    }

    private void ToggleAccount(Account acc, bool selected)
    {
        if (selected) selectedAccounts.Add(acc);
        else selectedAccounts.Remove(acc);
    }

    private async Task CreateStocktake()
    {
        try
        {
            await StocktakeService.CreateNewStocktake(newStocktake.Name, newStocktake.Description,
                selectedItems, selectedAccounts, newStocktake.StartDate, newStocktake.EndDate);
            HideCreateModal();
            await LoadData();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
    }

    private async Task StartStocktake(int id)
    {
        var s = await StocktakeService.GetStocktakeById(id);
        s.Status = StockTakeStatus.InProgress;
        s.StartDate = DateTime.Now;
        await StocktakeService.UpdateStocktake(s);
        await LoadData();
    }

    private async Task CompleteStocktake(int id)
    {
        var s = await StocktakeService.GetStocktakeById(id);
        s.Status = StockTakeStatus.Completed;
        s.EndDate = DateTime.Now;
        await StocktakeService.UpdateStocktake(s);
        await LoadData();
    }

    private void ShowCancelConfirm(int id) => cancelStocktakeId = id;

    private async Task ConfirmCancelStocktake()
    {
        if (cancelStocktakeId.HasValue)
        {
            var s = await StocktakeService.GetStocktakeById(cancelStocktakeId.Value);
            s.Status = StockTakeStatus.Cancelled;
            await StocktakeService.UpdateStocktake(s);
            cancelStocktakeId = null;
            await LoadData();
        }
    }

    private void HideCancelModal() => cancelStocktakeId = null;

    private void ViewDetails(int id) => NavigationManager.NavigateTo($"/stocktake/{id}");
}