@page "/settings"
@using InventoryLibrary.Services.Interfaces
@using InventoryWeb.Models
@inject ISettingsService SettingsService
@inject NavigationManager NavigationManager
@rendermode InteractiveServer
<div class="container mt-4">
    <h3>Application Settings</h3>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if(!hasError)
    {
            <EditForm Model="settingsModel" OnValidSubmit="SaveSettings">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="mb-3">
                    <label class="form-label">File Storage Path</label>
                    <InputText class="form-control" @bind-Value="settingsModel.FileStoragePath" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Max File Size (MB)</label>
                    <InputNumber class="form-control" @bind-Value="settingsModel.MaxFileSizeMB" />
                </div>

                <div class="mb-3">
                    <div class="form-check">
                        <InputCheckbox class="form-check-input" @bind-Value="settingsModel.EnableNotifications" />
                        <label class="form-check-label">Enable Notifications</label>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Company Name</label>
                    <InputText class="form-control" @bind-Value="settingsModel.CompanyName" />
                </div>

                <button type="submit" class="btn btn-primary">Save Settings</button>
                <button type="button" class="btn btn-secondary" @onclick="Cancel">Cancel</button>

                @if (showMessage)
                {
                    <div class="alert alert-success mt-3">Settings saved successfully!</div>
                }
            </EditForm>

            <hr class="my-4" />

            <h4>All Settings (Advanced)</h4>
            <table class="table">
                <tbody>
                    @foreach (var setting in settings)
                    {
                        <tr>
                            <td>@setting.Key</td>
                            <td>@setting.Value</td>
                        </tr>
                    }
                </tbody>
            </table>
        }else{
            <h3>No connection with Database</h3>
        }
</div>

@code {
    private bool isLoading = true;
    private bool hasError = false;
    private List<Setting>? settings;
    private SettingsModel settingsModel = new();
    private bool showMessage = false;


    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        try
        {
            settings = await SettingsService.GetSettings();

            settingsModel.FileStoragePath = settings.Find(s => s.Key == "FileStoragePath")?.Value ?? "";
            settingsModel.MaxFileSizeMB = settings.Find(s => s.Key == "MaxFileSize") != null
            ? int.Parse(settings.Find(s => s.Key == "MaxFileSize")!.Value) / (1024 * 1024)
            : 10;
            settingsModel.EnableNotifications = settings.Find(s => s.Key == "EnableNotifications") != null
            ? bool.Parse(settings.Find(s => s.Key == "EnableNotifications")!.Value)
            : true;
            settingsModel.CompanyName = settings.Find(s => s.Key == "CompanyName")?.Value ?? "";
        }
        catch (Exception e)
        {
            hasError = true;
            Console.WriteLine($"Settings Error: {e.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SaveSettings()
    {
        await SettingsService.UpdateSetting(settingsModel);

        showMessage = true;
        _ = LoadDataAsync();
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/");
    }
}