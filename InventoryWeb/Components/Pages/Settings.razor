@page "/settings"
@using InventoryLibrary.Services.Interfaces
@using InventoryWeb.Models
@using InventoryLibrary.Model.Location
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin")]

@inject ISettingsService SettingsService
@inject NavigationManager NavigationManager
@inject InventoryLibrary.Services.Interfaces.IDepartmentService departmentService
@rendermode InteractiveServer

<PageTitle>Settings</PageTitle>
<div class="d-flex justify-content-center">
    <div class="py-4 d-flex flex-column">

        @if (isLoading)
        {
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        }
        else if (hasError)
        {
            <div class="alert alert-danger">
                <h3>@errorMessage</h3>
            </div>
        }
        else

        {
            <Card Style="width:50rem; margin-bottom:2rem">
                <CardHeader>
                    <h3>Application Settings</h3>
                </CardHeader>
                <CardBody>


                    <EditForm Model="settingsModel" OnValidSubmit="SaveSettings">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        <div class="mb-3">
                            <label class="form-label">File Storage Path</label>
                            <InputText class="form-control" @bind-Value="settingsModel.FileStoragePath" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Max File Size (MB)</label>
                            <InputNumber class="form-control" @bind-Value="settingsModel.MaxFileSizeMB" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Company Name</label>
                            <InputText class="form-control" @bind-Value="settingsModel.CompanyName" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Chosen Department</label>
                            <InputSelect class="form-select" @bind-Value="settingsModel.ChosenDepartmentId">
                                <option value="">(none)</option>
                                @foreach (var d in departments)
                                {
                                    <option value="@d.Id">@d.DepartmentName</option>
                                }
                            </InputSelect>
                        </div>

                        <button type="submit" class="btn btn-primary">Save Settings</button>
                        <button type="button" class="btn btn-secondary" @onclick="Cancel">Cancel</button>

                        @if (showMessage)
                        {
                            <div class="alert alert-success mt-3">Settings saved successfully!</div>
                        }
                    </EditForm>
                </CardBody>
            </Card>



        }
    </div>
</div>



@code {
    private bool isLoading = true;
    private bool hasError = false;
    private string errorMessage = "";
    private List<Setting>? settings;
    private SettingsModel settingsModel = new();
    private bool showMessage = false;
    private List<InventoryLibrary.Model.Location.Department> departments = new();


    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        try
        {
            hasError = false;
            isLoading = true;
            errorMessage="";
            settings = await SettingsService.GetSettings();

            settingsModel.FileStoragePath = settings.Find(s => s.Key == "FileStoragePath")?.Value ?? "";
            settingsModel.MaxFileSizeMB = settings.Find(s => s.Key == "MaxFileSize") != null
            ? int.Parse(settings.Find(s => s.Key == "MaxFileSize")!.Value) / (1024 * 1024)
            : 10;
            settingsModel.CompanyName = settings.Find(s => s.Key == "CompanyName")?.Value ?? "";

                var deps = await departmentService.GetAllDepartmentsAsync();
                if (deps != null) departments = deps.ToList();


            if (settingsModel.ChosenDepartmentId == null && settings != null)
            {
                var chosenVal = settings.Find(s => s.Key == "ChosenDepartmentId")?.Value;
                if (!string.IsNullOrWhiteSpace(chosenVal) && int.TryParse(chosenVal, out var cid)) settingsModel.ChosenDepartmentId =
                cid;
            }
        }
        catch (Exception ex)
        {
            hasError = true;
            errorMessage = $"There was an Error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SaveSettings()
    {
        await SettingsService.UpdateSetting(settingsModel);

        showMessage = true;
        _ = LoadDataAsync();
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/");
    }
}