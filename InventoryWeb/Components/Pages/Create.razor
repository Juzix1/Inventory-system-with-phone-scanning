@page "/create/{EditID:int?}"
@using InventoryLibrary.Model.Data
@using InventoryLibrary.Model.Inventory
@using InventoryLibrary.Services
@using InventoryLibrary.Services.Interfaces
@using InventoryLibrary.Services.data
@using InventoryWeb.Components.Shared.EditForms
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@inject IInventoryService db
@inject ITypeService typeService
@inject HttpClient Http
@inject ILogger<Create> Logger
@rendermode InteractiveServer

<div class="itemForm">
    @if(EditID.HasValue)
    {
        <h3>Edit Item</h3>
            @if(Item != null)
        {
            if (Item.ItemType.Id == 2)
            { 
                <AGDEditForm 
                OnCancel="Cancel" 
                itemTypeId="Item.ItemType.Id" 
                Model="@AgdItem" />
            }
            else
            {
                <BaseEditForm 
                OnCancel="Cancel" 
                itemTypeId="Item.ItemType.Id"
                Model="@Item"/>
            }
        }
        else
        {
            <p>Item not found.</p>
        }
    }
    else
    {
        <h3>Create new item</h3>
        @if (selectedTypeId != 0)
        {
            if (selectedTypeId == 2)
            {
                <AGDEditForm OnCancel="Cancel" itemTypeId="selectedTypeId" />
            }
            else
            {
                <BaseEditForm OnCancel="Cancel" itemTypeId="selectedTypeId" />
            }
        }
        else
        {
            <form class="form-container" method="post">
                <div class="mb-3">
                    <label for="itemType" class="form-label">Item Type</label>
                    <select id="itemType" class="form-select" @bind="selectedTypeId">
                        <option value="0">Select a type</option>
                        @foreach (var type in types)
                        {
                            <option value="@type.Id">@type.TypeName</option>
                        }
                    </select>
                </div>
            </form>
        }
    }
    
    @if (!string.IsNullOrEmpty(uploadMessage))
    {
        <div class="alert alert-info mt-3">@uploadMessage</div>
    }
</div>

@code {
    [Parameter]
    public int? EditID { get; set; }
    
    List<ItemType> types = new List<ItemType>();
    InventoryItem Item;
    AGD AgdItem;
    int selectedTypeId;
    string uploadMessage;
    
    protected override async Task OnInitializedAsync()
    {
        types = await typeService.GetAllTypesAsync();
        
        if(EditID.HasValue)
        {
            Item = await db.GetItemByIdAsync(EditID.Value);
            if(Item != null)
            {
                selectedTypeId = Item.ItemType.Id;
                if(Item.ItemType.Id == 2)
                {
                    AgdItem = await db.GetItemByIdAsync(EditID.Value) as AGD;
                }
            }
        }
    }

    
    
    private Task Cancel()
    {
        selectedTypeId = 0;
        return Task.CompletedTask;
    }
    
    
}