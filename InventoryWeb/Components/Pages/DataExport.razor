@page "/data/export"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin")]


@inject HttpClient Http
@inject NavigationManager nav;
@inject IJSRuntime JS

<PageTitle>Export Data</PageTitle>

@if (hasError)
{
    <div class="alert alert-danger">
        <h3>No connection with Database</h3>
    </div>
}else{

<div class="container mt-4">
    <Card>
        <CardHeader>
            <h3>Export data to Excel</h3>
        </CardHeader>
        <CardBody>
            <h5 class="card-title">Download</h5>
            <button class="btn btn-primary" @onclick="DownloadFile" disabled="@isDownloading">
                @if (isDownloading)
                {
                    <span class="spinner-border spinner-border-sm me-2"></span>
                }
                <i class="bi bi-download me-2"></i>
                Download Excel file
            </button>
        </CardBody>
    </Card>

</div>
}

@code {
    private bool hasError = false;
    private bool isDownloading = false;
    private string errorMessage = string.Empty;
    private Result? exportResult;

    private async Task DownloadFile()
    {
        try
        {
            isDownloading = true;
            hasError = false;
            errorMessage = string.Empty;

            nav.NavigateTo("/api/import/download", forceLoad: true);

            await Task.Delay(500);
        }
        catch (Exception ex)
        {
            hasError = true;
            errorMessage = $"There was an Error: {ex.Message}";
        }
        finally
        {
            isDownloading = false;
        }
    }
    public class Result
    {
        public int SuccessCount { get; set; }
        public List<string> Errors { get; set; } = new();
        public bool IsSuccess => Errors.Count == 0;
        public string? Message { get; set; }
    }
}