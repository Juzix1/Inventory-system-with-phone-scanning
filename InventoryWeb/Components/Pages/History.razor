@page "/history"
@using InventoryLibrary.Model.Logs
@using InventoryLibrary.Services.Interfaces
@using Microsoft.AspNetCore.Authorization
@rendermode InteractiveServer
@inject ILogReaderService Logger
@attribute [Authorize(Roles = "Admin")]

<PageTitle>System Logs</PageTitle>

<div class="p-3">
    <div class="mb-3">
        <Card>
            <CardHeader>
                <CardTitle>
                    <h3>App Logs</h3>
                </CardTitle>
            </CardHeader>
            <CardBody>


                <button class="btn btn-primary" @onclick="LoadLogs"><Icon Name="IconName.ArrowClockwise"/> Odśwież</button>

                <select class="form-select" style="width: 200px; display: inline-block; margin-left: 10px;"
                    @onchange="FilterByLevel">
                    <option value="">All types</option>
                    <option value="INFO">INFO</option>
                    <option value="WRN">WARNING</option>
                    <option value="ERROR">ERROR</option>
                </select>

                <select class="form-select" style="width: 200px; display: inline-block; margin-left: 10px;"
                    @onchange="FilterBySource">
                    <option value="">All Sources</option>
                    @foreach (var source in sources)
                    {
                        <option value="@source">@source</option>
                    }
                </select>

            </CardBody>
        </Card>
    </div>


    @if (logs == null)
    {
        <p><em>Loading Logs ...</em></p>
    }
    else if (!logs.Any())
    {
        <p><em>No logs available.</em></p>
    }
    else
    {
        <div class="log-container">
            @foreach (var log in GetFilteredLogs())
            {
                <div class="log-entry">
                    <span class="timestamp">@log.Timestamp.ToString("dd-MM-yyyy HH:mm")</span>
                    <span class="log @GetLogClass(log.Level)">[@log.Level]</span>
                    <span class="log-source">[@log.Source]</span>
                    <span class="log-message">@log.Message</span>
                </div>
            }
        </div>

        <div class="mt-3">
            <small class="text-muted">Showed @GetFilteredLogs().Count() z @logs.Count logs</small>
        </div>
    }
</div>


@code {
    private List<LogEntry> logs;
    private string selectedLevel = "";
    private string selectedSource = "";
    private List<string> sources = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadLogs();
    }

    private async Task LoadLogs()
    {
        logs = await Logger.GetLogsAsync(500);
        sources = logs.Select(l => l.Source).Distinct().OrderBy(s => s).ToList();
        StateHasChanged();
    }

    private void FilterByLevel(ChangeEventArgs e)
    {
        selectedLevel = e.Value?.ToString() ?? "";
    }

    private void FilterBySource(ChangeEventArgs e)
    {
        selectedSource = e.Value?.ToString() ?? "";
    }

    private List<LogEntry> GetFilteredLogs()
    {
        var filtered = logs.AsEnumerable();

        if (!string.IsNullOrEmpty(selectedLevel))
        {
            filtered = filtered.Where(l => l.Level == selectedLevel);
        }

        if (!string.IsNullOrEmpty(selectedSource))
        {
            filtered = filtered.Where(l => l.Source == selectedSource);
        }

        return filtered.ToList();
    }

    private string GetLogClass(string level)
    {
        return $"log-{level}";
    }
}