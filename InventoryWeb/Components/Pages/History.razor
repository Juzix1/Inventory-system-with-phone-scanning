@page "/history"
@using InventoryLibrary.Model.Logs
@using InventoryLibrary.Services.Interfaces
@using Microsoft.AspNetCore.Authorization
@rendermode InteractiveServer
@inject ILogReaderService Logger
@attribute [Authorize(Roles = "Admin")]

<PageTitle>System Logs</PageTitle>

<h3>Logi aplikacji</h3>
<div class="mb-3">
    <button class="btn btn-primary" @onclick="LoadLogs">Odśwież</button>
    
    <select class="form-select" style="width: 200px; display: inline-block; margin-left: 10px;" @onchange="FilterByLevel">
        <option value="">Wszystkie poziomy</option>
        <option value="INFO">INFO</option>
        <option value="WRN">WARNING</option>
        <option value="ERROR">ERROR</option>
    </select>
    
    <select class="form-select" style="width: 200px; display: inline-block; margin-left: 10px;" @onchange="FilterBySource">
        <option value="">Wszystkie źródła</option>
        @foreach (var source in sources)
        {
            <option value="@source">@source</option>
        }
    </select>
</div>

@if (logs == null)
{
    <p><em>Ładowanie logów...</em></p>
}
else if (!logs.Any())
{
    <p><em>Brak logów do wyświetlenia.</em></p>
}
else
{
    <div class="log-container" style="max-height: 600px; overflow-y: auto; background: #1e1e1e; padding: 15px; border-radius: 5px;">
        @foreach (var log in GetFilteredLogs())
        {
            <div class="log-entry" style="margin-bottom: 8px;">
                <span style="color: #858585;">@log.Timestamp.ToString("yyyy-MM-dd HH:mm:ss")</span>
                <span class="@GetLogClass(log.Level)" style="margin-left: 10px; font-weight: bold;">[@log.Level]</span>
                <span style="color: #569cd6; margin-left: 10px; font-weight: bold;">[@log.Source]</span>
                <span style="color: #d4d4d4; margin-left: 10px;">@log.Message</span>
            </div>
        }
    </div>
    
    <div class="mt-3">
        <small class="text-muted">Wyświetlono @GetFilteredLogs().Count() z @logs.Count logów</small>
    </div>
}

<style>
    .log-container {
        font-family: 'Courier New', monospace;
        font-size: 13px;
    }
    
    .log-INFO { color: #4ec9b0; }
    .log-WARNING { color: #dcdcaa; }
    .log-ERROR { color: #f48771; }
</style>

@code {
    private List<LogEntry> logs;
    private string selectedLevel = "";
    private string selectedSource = "";
    private List<string> sources = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadLogs();
    }

    private async Task LoadLogs()
    {
        logs = await Logger.GetLogsAsync(500);
        sources = logs.Select(l => l.Source).Distinct().OrderBy(s => s).ToList();
        StateHasChanged();
    }

    private void FilterByLevel(ChangeEventArgs e)
    {
        selectedLevel = e.Value?.ToString() ?? "";
    }

    private void FilterBySource(ChangeEventArgs e)
    {
        selectedSource = e.Value?.ToString() ?? "";
    }

    private List<LogEntry> GetFilteredLogs()
    {
        var filtered = logs.AsEnumerable();

        if (!string.IsNullOrEmpty(selectedLevel))
        {
            filtered = filtered.Where(l => l.Level == selectedLevel);
        }

        if (!string.IsNullOrEmpty(selectedSource))
        {
            filtered = filtered.Where(l => l.Source == selectedSource);
        }

        return filtered.ToList();
    }

    private string GetLogClass(string level)
    {
        return $"log-{level}";
    }
}